services:
  notifypit:
    build: .
    ports:
      - "4567:4567"
    environment:
      - RACK_ENV=test
      - GO_TEMPLATE_ID=go_template_id
    logging:
      options:
        mode: non-blocking
    command: bundle exec rackup --host 0.0.0.0 --port 4567 config.ru
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4567/health"]
      interval: 5s
      timeout: 5s
      retries: 5

  test:
    build: .
    depends_on:
      notifypit:
        condition: service_healthy
    environment:
      - RACK_ENV=test
    command: ["bundle", "exec", "rspec"]

  lint:
    build: .
    command: ["bundle", "exec", "rubocop"]